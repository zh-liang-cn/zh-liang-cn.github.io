<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>Linux上diff命令详解 | 周亮的博客</title><meta name="description" content="Linux上diff命令详解 - Liang"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/theme.css"><link rel="search" type="application/opensearchdescription+xml" href="/atom.xml" title="周亮的博客"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="周亮的博客" type="application/atom+xml">
</head><body><div class="wrap"><header><h1 class="branding"><a href="/" title="周亮的博客">周亮的博客</a></h1><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self">HOME</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives" target="_self">ARCHIVES</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://github.com/zh-liang-cn/" target="_blank">GITHUB</a></li><li class="nav-list-item"><a class="nav-list-link" href="/atom.xml" target="_self">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Linux上diff命令详解</h1><div class="post-info"><a></a>2012-03-05</div><div class="post-content"><p><a href="http://en.wikipedia.org/wiki/Diff" target="_blank">diff</a>程序是linux上非常重要的工具，用于比较文件的内容，特别是比较两个版本不同的文件(本文中的a.c、b.c可以理解为两个版本的同一个文件，b.c是在a.c的基础上的修正版)以找到改动的地方。diff在命令行中打印每一个行的改动。最新版本的diff还支持二进制文件。diff程序的输出被称为补丁(patch)，因为unix系统中还有一个<a href="http://en.wikipedia.org/wiki/Patch_(Unix)" target="_blank">patch</a>程序，可以根据diff的输出将a.c的文件内容更新为b.c。diff是svn、cvs、git等版本控制工具不可或缺的一部分。</p>
<h2 id="diff和patch实例"><a href="#diff和patch实例" class="headerlink" title="diff和patch实例"></a>diff和patch实例</h2><p>下面用一个实例来讲述diff和patch的使用。</p>
<p>文件a.c的内容如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// add code here</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>文件b.c的内容如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello world&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">diff a.c b.c &gt; b.patch</span><br></pre></td></tr></table></figure>

<p>输出b.patch的内容如下：</p>
<pre><code>5c5
&lt;     // add code here
---
printf(&quot;Hello world&quot;);
</code></pre>
<p>接着执行下面的命令就可以将patch文件b.patch应用于a.c文件上，将a.c文件的内容更新为新的版本(即b.c)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">patch a.c b.patch</span><br></pre></td></tr></table></figure>

<p>a.c的内容被更新为b.c的内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello world&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不过，diff的输出让人读起来很废劲，因为这个输出本来就不是给人看的，如果你知道一点关于<a href="http://en.wikipedia.org/wiki/Ed_(Unix)" target="_blank">ed</a>编辑器的用法，就容易理解了。最开始的时候diff的输出不是这种格式的，后来受到<a href="http://en.wikipedia.org/wiki/Ed_(Unix)" target="_blank">ed</a>编辑器的影响才变成这个样子，至于其发展历程请移步<a href="http://en.wikipedia.org/wiki/Diff#History" target="_blank">维基百科</a>，因此在解释diff的输出之前，先简单介绍一下<a href="http://en.wikipedia.org/wiki/Ed_(Unix)" target="_blank">ed</a>编辑器。</p>
<h2 id="ed编辑器"><a href="#ed编辑器" class="headerlink" title="ed编辑器"></a>ed编辑器</h2><p>ed是一个交互式的文本编辑器，类Unix系统中有很多很神奇的编辑器，号称神器的有vi、vim、emacs，还有常规意义的编辑器nano、gedit，还有看起来很诡异的sed(<strong>S</strong>tream <strong>Ed</strong>itor)、awk，ed这是另一个很诡异的编辑器，不同于前面的任何一种。</p>
<p>打开shell，按次序输入如下的命令(需要一句一句的敲)：</p>
<pre><code>touch c.c
ed c.c
0a

#include &lt;stdio.h&gt;
int main(int argc, char *argv[])
&#123;
    // add code here
    return 0;
&#125;
.
w
q
</code></pre>
<p>使用cat命令查看c.c，该文件的内容就是上面代码中“0a”和“.”之前代码。</p>
<p>和vim一样，ed通过一系列的命令来编辑文件：</p>
<ul>
<li>“ed c.c”表示用ed对文件c.c进行编辑</li>
<li>“0a”表示在第0行后进行添加(a表示add，同样，d表示删除，c表示修改)</li>
<li>接着输入需要添加的内容，输入完成后换一行，输入“.<CR>”(<CR>表示回车)，表示输入完成</li>
<li>输入“w<CR>”表示保存文件</li>
<li>输入“q<CR>”表示退出编辑器</li>
</ul>
<p>ed编辑器的好处在于可以将一系列命令写成一个文件，然后进行批量执行。比如需要在所有的源代码开头加上版权信息，则可以编写如下的ed文件，保存为add_header:</p>
<pre><code>0a
/**
 * &amp;copy; 2012 zhlwish.com
 */
.
w
q
</code></pre>
<p>然后写一段shell脚本对源代码文件进行遍历，对每个代码执行如下代码即可批量对源代码文件添加版权信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ed a.c &lt; add_header</span><br></pre></td></tr></table></figure>

<p>关于ed的命令和其他方法请参考<a href="http://www.softpanorama.org/Editors/Exorama/index.shtml" target="_blank">Unix ed Editor Command Set</a>本文不详述。</p>
<h2 id="diff的输出"><a href="#diff的输出" class="headerlink" title="diff的输出"></a>diff的输出</h2><p>diff的输出格式是对ed脚本(ed script)的一种扩展，遵循ed的命令语法，添加了”&lt;”和”&gt;”分别用于表示新文件的内容和旧文件的内容，比如前文中diff的输出可以按如下方式理解：</p>
<ul>
<li>“5c5”表示a.c的第5行有改动(<strong>c</strong>hange)，改动后为b.c的第5行</li>
<li>“&lt;     // add code here”表示a.c的第5行的内容</li>
<li>“— ”是分隔符</li>
<li>“&gt;     printf(“Hello world”);”表示b.c文件的第5行的内容</li>
</ul>
<p>当然还有更复杂的情况，如“3c3,6”、“6d8”，前者表示旧版本文件中的第3行被修改，对应新文件中的第3-6行，后者表示旧版本文件的第6行被删除，在新文件中是第8行。</p>
<p>可以通过参数指定diff输出格式，有兴趣的笔者可以分别进行尝试：</p>
<ul>
<li>-e –ed 输出为ed命令格式</li>
<li>-n –rcs 输出为rcs命令格式</li>
<li>-y 输出为两列对照模式</li>
<li>-c 输出为上下文模式</li>
</ul>
<h2 id="diff的选项"><a href="#diff的选项" class="headerlink" title="diff的选项"></a>diff的选项</h2><p>除以上选项外，diff的有用的选项还包括：</p>
<ul>
<li>-r：当diff的参数为文件夹时，diff会遍历整个文件夹对新旧文件夹下同名的文件进行比较</li>
<li>-w：忽略所有空格和制表符，将所有其他空白字符串视为一致。例如，if ( a == b ) 与 if(a==b) 相等。</li>
<li>-i：忽略字母大小写。例如，小写 a 被认为同大写 A 一样。</li>
</ul>
<p>因为成文仓促，不免有不对之处，敬请读者指正。(全文完)</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="http://baike.baidu.com/view/1374858.htm" target="_blank">Linux命令diff</a></li>
<li><a href="http://www.tsnc.edu.cn/tsnc_wgrj/doc/sed.htm" target="_blank">Sed学习笔记</a></li>
<li><a href="http://wiki.bash-hackers.org/howto/edit-ed" target="_blank">Editing files with the ed text editor from scripts</a></li>
<li><a href="http://www.softpanorama.org/Editors/Exorama/index.shtml" target="_blank">Unix ed Editor Command Set</a></li>
<li><a href="http://www.youtube.com/watch?gl=JP&v=jxlcIMPyAt4" target="_blank">Hello World” with ed editor</a>(Youtube)</li>
<li><a href="http://www.ibm.com/developerworks/cn/linux/l-diffp/" target="_blank">用Diff和Patch工具维护源码</a></li>
</ul>
</div></article></div></main><footer><div class="paginator"><a class="prev" href="/2012/04/17/mysql-procedure/">prev</a><a class="next" href="/2011/12/15/x-window-system/">next</a></div><div class="copyright"><p>&copy; 2012 - 2021 <a href="https://zh-liang-cn.github.io">Liang</a>.<br>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a href="https://github.com/Dreyer/hexo-theme-artemis" target="_blank">Artemis</a>.</p></div></footer></div></body></html>