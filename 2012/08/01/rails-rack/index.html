<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>[Rails代码解读]Rack在Rails中的使用 | 周亮的博客</title><meta name="description" content="[Rails代码解读]Rack在Rails中的使用 - Liang"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/theme.css"><link rel="search" type="application/opensearchdescription+xml" href="/atom.xml" title="周亮的博客"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="周亮的博客" type="application/atom+xml">
</head><body><div class="wrap"><header><h1 class="branding"><a href="/" title="周亮的博客">周亮的博客</a></h1><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self">HOME</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives" target="_self">ARCHIVES</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://github.com/zh-liang-cn/" target="_blank">GITHUB</a></li><li class="nav-list-item"><a class="nav-list-link" href="/atom.xml" target="_self">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">[Rails代码解读]Rack在Rails中的使用</h1><div class="post-info"><a></a>2012-08-01</div><div class="post-content"><p>今天工作中遇到Rails的一个问题，最后发现是使用的一个叫Rack包版本不兼容Rails2.3引起的，虽然问题很容易就解决了，但是Rack这个包是干什么的却引发了我的兴趣，经过查资料阅读代码，写了这篇博客。</p>
<p>Rack是一个中间件，介于Web应用程序和Web服务器之间，为所有的Web服务器都提供了统一的接口，使用Rack构建的Web应用程序能简单换到其他的Web服务器上，因为Rails在底层用到了Rack，所以我们可以在开发的时候使用Webrick，然后通过fastcgi或者ruby_mod发布到nginx或者Apache。 </p>
<h2 id="Rack简介"><a href="#Rack简介" class="headerlink" title="Rack简介"></a>Rack简介</h2><p>使用Rack构建的应用程序比Rails要简单多了，当然，功能也简单多了，只有request, response, session, logger等一些基本的组件，不过对于一些简单的应用，足够了。基于Rack的Web应用太简单了，以至于大家都用一句话来描述：</p>
<blockquote>
<p>A Rack application is any Ruby object that responds to the call method, takes a single hash parameter and returns an array containing the response status code, HTTP response headers and the response body as an array of strings.</p>
</blockquote>
<p>意思就是，一个包含<code>call(env)</code>方法的对象就能做为一个Rack Web应用，参数env是一个hash，方法的返回值是一个列表，包含三个元素：HTTP状态码(200, 500等)，HTTP响应头(Hash)，HTTP响应内容(字符串数组)。</p>
<p>先安装rack和mongrel：</p>
<pre><code>sudo gem install rack
sudo gem install mongrel --pre
</code></pre>
<p>下面代码演示了如何创建一个用Rack来创建一个Web应用，在控制台中执行下面的代码，然后用浏览器访问 <a target="_blank" rel="noopener" href="http://localhost:3000/">http://localhost:3000</a>，即可看到显示 <strong>Hello Rack!</strong> 的页面。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env ruby</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;rubygems&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;rack&#x27;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloRack</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">call</span><span class="params">(env)</span></span></span><br><span class="line">        [</span><br><span class="line">            <span class="number">200</span>,</span><br><span class="line">            &#123;<span class="string">&quot;Content-Type&quot;</span> =&gt; <span class="string">&quot;text/html&quot;</span>&#125;,</span><br><span class="line">            [<span class="string">&quot;Hello Rack!&quot;</span>]</span><br><span class="line">        ]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">Rack::Handler::Mongrel.run(HelloRack.new, <span class="symbol">:Port</span> =&gt; <span class="number">3000</span>)</span><br></pre></td></tr></table></figure>

<p>我们可以将后端的Web服务器Ruby标准库中的WEBrick，只需要将上面代码的最后一行改为：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rack::Handler::WEBrick.run(HelloRack.new, <span class="symbol">:Port</span> =&gt; <span class="number">3000</span>)</span><br></pre></td></tr></table></figure>

<p>当然要是Rack只能支持对于根路径的响应就没有啥意义了，Rack还提供了一个称为<a target="_blank" rel="noopener" href="http://rack.rubyforge.org/doc/Rack/Builder.html">Rack::Builder</a>的API，提供了简单的DSL，可以定义简单的URL mapping，使对不同路径的请求由不同的程序来处理，不过，这个和Rails暂时无关，有兴趣请阅读<a target="_blank" rel="noopener" href="http://m.onkey.org/ruby-on-rack-1-hello-rack">Ruby on Rack #1 - Hello Rack!</a>和<a target="_blank" rel="noopener" href="http://m.onkey.org/ruby-on-rack-2-the-builder">Ruby on Rack #2 - The Builder</a>，或者<a target="_blank" rel="noopener" href="http://blog.ixti.net/development/ruby/2011/09/03/understanding-rack-builder/">Understanding Rack Builder</a>。</p>
<p>Rack还提供一个有意思的东西，叫rakeup，使得可以将主要的对请求的响应都放在一个名为<code>config.ru</code>文件中，和Rails关系不大，这篇文章可能讲解得更加清楚一些：<a target="_blank" rel="noopener" href="http://ruby.about.com/od/rack/a/Using-Rack.htm">Using Rack</a>。</p>
<p>我目前发现的，真正和Rails相关的，是<a target="_blank" rel="noopener" href="http://rack.rubyforge.org/doc/classes/Rack/Server.html">Rack::Server</a> API。下面是一个简单的示例：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Rack::Server.start(</span><br><span class="line">  <span class="symbol">:app</span> =&gt; <span class="built_in">proc</span> &#123;<span class="params">|env|</span> <span class="number">200</span>, &#123;<span class="string">&quot;Content-Type&quot;</span> =&gt; <span class="string">&quot;text/html&quot;</span>&#125;, [<span class="string">&quot;Hello Rack!&quot;</span>]]&#125;,</span><br><span class="line">  <span class="symbol">:server</span> =&gt; <span class="string">&#x27;webrick&#x27;</span>,</span><br><span class="line">  <span class="symbol">:Port</span> =&gt; <span class="number">3030</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><code>Server#start()</code>的参数是一个Hash，其参数包括<code>:server</code>, <code>:Host</code>, <code>:Port</code>等，其中<code>:config</code>可以是一个<code>.ru</code>文件的路径，用于覆盖<code>:app</code>的配置，比如下面代码，我们从<code>config.ru</code>中读取处理请求的函数，比如下面的代码。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Rack::Server.start(</span><br><span class="line">  <span class="symbol">:config</span> =&gt; <span class="string">&#x27;config.ru&#x27;</span></span><br><span class="line">  <span class="symbol">:server</span> =&gt; <span class="string">&#x27;webrick&#x27;</span>,</span><br><span class="line">  <span class="symbol">:Port</span> =&gt; <span class="number">3030</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>_config.ru_的代码如下所示，仅仅一行。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run <span class="built_in">proc</span> &#123;<span class="params">|env|</span> [<span class="number">200</span>, &#123;<span class="string">&quot;Content-Type&quot;</span> =&gt; <span class="string">&#x27;text/html&#x27;</span>&#125;, [<span class="string">&quot;Hello Rack!&quot;</span>]]&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Rails中的Rack"><a href="#Rails中的Rack" class="headerlink" title="Rails中的Rack"></a>Rails中的Rack</h2><p>对Rails的分析采用倒推的方式，我们启动Rails应用的时候，使用<code>rails server</code>命令。这个命令会调用<a target="_blank" rel="noopener" href="https://github.com/rails/rails/blob/master/railties/lib/rails/commands/server.rb">railties/lib/rails/commands/server.rb</a>代码，下面是代码的节选。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Rails</span></span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Server</span> &lt; ::<span class="title">Rack::Server</span></span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">start</span></span></span><br><span class="line">            <span class="comment"># ...</span></span><br><span class="line">            <span class="keyword">super</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">default_options</span></span></span><br><span class="line">            <span class="keyword">super</span>.merge(&#123;</span><br><span class="line">                <span class="symbol">:Port</span>        =&gt; <span class="number">3000</span>,</span><br><span class="line">                <span class="symbol">:DoNotReverseLookup</span> =&gt; <span class="literal">true</span>,</span><br><span class="line">                <span class="symbol">:environment</span> =&gt; (ENV[<span class="string">&#x27;RAILS_ENV&#x27;</span>] <span class="params">||</span> <span class="string">&quot;development&quot;</span>).dup,</span><br><span class="line">                <span class="symbol">:daemonize</span>   =&gt; <span class="literal">false</span>,</span><br><span class="line">                <span class="symbol">:debugger</span>    =&gt; <span class="literal">false</span>,</span><br><span class="line">                <span class="symbol">:pid</span>         =&gt; File.expand_path(<span class="string">&quot;tmp/pids/server.pid&quot;</span>),</span><br><span class="line">                <span class="symbol">:config</span>      =&gt; File.expand_path(<span class="string">&quot;config.ru&quot;</span>)</span><br><span class="line">            &#125;)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>可以看到，<code>Rails::Server</code>继承了<code>Rack::Server</code>，在前一节已经了解到，<code>Rack::Server#start()</code>方法会启动服务，<code>Rails:Server</code>覆盖了<code>start()</code>方法，并且在做了一些处理之后使用<code>super</code>调用了父类的同名方法，因此调用这个方法同样能启动服务。而且，<code>Rails:Server</code>也覆盖了父类的<code>default_options()</code>，这里的<code>super</code>也表示调用父类的同名方法，其返回值为Hash，使用<code>Hash#merge()</code>覆盖了父类的一些配置信息，比如将Rack默认的9292端口改为3000，等等。最后是最为关键的配置信息：<code>:config =&gt; File.expand_path(&quot;config.ru&quot;)</code>，意味着<code>Rails::Server</code>会读取从Rails App根目录的<code>config.ru</code>，然后交给Rack执行。</p>
<p>在Rails App的根目录下面找到<code>config.ru</code>，里面一如既往的简单，只有两条语句：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="symbol">:</span><span class="symbol">:File</span>.expand_path(<span class="string">&#x27;../config/environment&#x27;</span>,  <span class="keyword">__FILE__</span>)</span><br><span class="line">run AppName::Application</span><br></pre></td></tr></table></figure>

<p>第一句是加载<code>config/environment.rb</code>，第二句和前一节的最后一段的代码非常相似，我们现在可以勇敢地猜测，<code>AppName::Application</code>中肯定定义了<code>call(env)</code>方法。</p>
<p>Rails3的<code>config/environment.rb</code>文件也很简单，第一句加载相同目录下的<code>application.rb</code>，第二句调用了<code>AppName::Application</code>的<code>initialize!()</code>方法。(注意，Rails2的启动流程不一样)。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> File.expand_path(<span class="string">&#x27;../application&#x27;</span>, <span class="keyword">__FILE__</span>)</span><br><span class="line">AppName::Application.initialize!</span><br></pre></td></tr></table></figure>

<p><code>config/application.rb</code>还是的定义依然很简单，继承了<code>Rails::Application</code>，仅仅做了一些配置工作，比如禁止在log文件中记录<code>:password</code>，启用Rails3新引入的SASS和Coffie Script。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">AppName</span></span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Application</span> &lt; Rails::Application</span></span><br><span class="line">        config.encoding = <span class="string">&quot;utf-8&quot;</span></span><br><span class="line">        config.filter_parameters += [<span class="symbol">:password</span>]</span><br><span class="line">        config.active_record.whitelist_attributes = <span class="literal">true</span></span><br><span class="line">        config.assets.enable = <span class="literal">true</span></span><br><span class="line">        config.assets.version = <span class="string">&#x27;1.0&#x27;</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>因此，进一步找到<a target="_blank" rel="noopener" href="https://github.com/rails/rails/blob/master/railties/lib/rails/application.rb">railties/lib/rails/application.rb</a>，这个文件定义了<code>Rails::Application</code>，而且终于看到了我们预测中的<code>call(env)</code>。当然，除此以外Rails做的更多，比如定义了<a target="_blank" rel="noopener" href="https://github.com/rails/rails/blob/master/railties/lib/rails/rack/logger.rb">Rails::Rack::Logger</a>用来替代Rack自身的日志系统。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Rails</span></span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Application</span> &lt; Engine</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">call</span><span class="params">(env)</span></span></span><br><span class="line">            env[<span class="string">&quot;ORIGINAL_FULLPATH&quot;</span>] = build_original_fullpath(env)</span><br><span class="line">            <span class="keyword">super</span>(env)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>另外，<code>Rails::Application</code>的父类<a target="_blank" rel="noopener" href="https://github.com/rails/rails/blob/master/railties/lib/rails/engine.rb">Rails::Engine</a>是Rails的启动配置的核心所在，一次加载了config/routes.rb、app/views等信息。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>总的来说，Rails首先加载了<code>config/application.rb</code>中定义了<code>AppName::Application</code>，然后调用其<code>initialize!()</code>方法执行一些初始化工作，最后使用Rack的<code>run AppName::Application</code>运行整个应用程序。Rails也通过Rack可以很方便的部署于Apache、nginx、lighttpd等各种服务器，包括Ruby自带的Webrick，以及mongrel等。要更深入的了解Rack需要进一步阅读参考中的链接。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="http://ruby.about.com/od/rack/a/What-Is-Rack.htm">What’s Rack</a></li>
<li><a target="_blank" rel="noopener" href="http://ruby.about.com/od/rack/a/Using-Rack.htm">Using Rack</a></li>
<li><a target="_blank" rel="noopener" href="http://chneukirchen.org/blog/archive/2007/02/introducing-rack.html">Introducing Rack</a></li>
<li><a target="_blank" rel="noopener" href="http://rack.rubyforge.org/doc/SPEC.html">Rake Spec</a></li>
<li><a target="_blank" rel="noopener" href="http://m.onkey.org/ruby-on-rack-1-hello-rack">Ruby on Rack, Hello Rack</a></li>
<li><a target="_blank" rel="noopener" href="http://m.onkey.org/ruby-on-rack-2-the-builder">Ruby on Rack, The builder</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.ixti.net/development/ruby/2011/09/03/understanding-rack-builder/">Understanding Rack Builder</a></li>
<li><a target="_blank" rel="noopener" href="http://rack.rubyforge.org/doc/">rack doc</a></li>
</ul>
</div></article></div></main><footer><div class="paginator"><a class="prev" href="/2012/09/11/javascript-date/">prev</a><a class="next" href="/2012/07/23/rails-activesupport-concern/">next</a></div><div class="copyright"><p>&copy; 2012 - 2021 <a href="https://zh-liang-cn.github.io">Liang</a>.<br>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a href="https://github.com/Dreyer/hexo-theme-artemis" target="_blank">Artemis</a>.</p></div></footer></div></body></html>